lstoff

; **************************************************************************************************
; OZ ram variables area definitions.
;
; This file is part of the Z88 operating system, OZ      0000000000000000      ZZZZZZZZZZZZZZZZZZZ
;                                                       000000000000000000   ZZZZZZZZZZZZZZZZZZZ
; OZ is free software; you can redistribute it and/    0000            0000              ZZZZZ
; or modify it under the terms of the GNU General      0000            0000            ZZZZZ
; Public License as published by the Free Software     0000            0000          ZZZZZ
; Foundation; either version 2, or (at your option)    0000            0000        ZZZZZ
; any later version. OZ is distributed in the hope     0000            0000      ZZZZZ
; that it will be useful, but WITHOUT ANY WARRANTY;    0000            0000    ZZZZZ
; without even the implied warranty of MERCHANTA-       000000000000000000   ZZZZZZZZZZZZZZZZZZZZ
; BILITY or FITNESS FOR A PARTICULAR PURPOSE. See        0000000000000000  ZZZZZZZZZZZZZZZZZZZZ
; the GNU General Public License for more details.
; You should have received a copy of the GNU General Public License along with OZ; see the file
; COPYING. If not, write to:
;                                  Free Software Foundation, Inc.
;                                  59 Temple Place-Suite 330,
;                                  Boston, MA 02111-1307, USA.
;
; Original implementation by
; (C) Jorma Oksanen (jorma.oksanen@aini.fi), 2003
;
; Additional improvements, comments, definitions and new implementations by
; (C) Thierry Peycru (pek@users.sf.net), 2005-2007
; (C) Gunther Strube (gbs@users.sf.net), 2005-2007
;
; $Id$
; ***************************************************************************************************
;
; ***************************************************************************************************
; ***                             INTERNAL OPERATING SYSTEM USAGE ONLY                            ***
; ***************************************************************************************************
;
;
;       variable prefix:
;
;       a       ASCII string
;       c       character code
;       p       pointer (16 bits)
;       e       extended pointer (24 bits)
;       f       float (40 bits)
;
;       sl      signed long (32 bits)
;       ul      unsigned long (32 bits)
;       sw      signed word (16 bits)
;       uw      unsigned word (16 bits)
;       sb      signed byte (8 bits)
;       ub      unsigned byte (8 bits)
;
;
; Constants are all uppercase

include "kernel.def"                            ; to be removed (and renamed oz.def)
include "z80.def"                               ; to be removed and inlined in each file


defc    SYSVAR_AREA             = $020B
defc    PRESERVED_AREA          = $0400
defc    HARDWARE_AREA           = $0460
defc    SYS_2_AREA              = $0500
defc    PROCESS_AREA            = $1800

; System variable area

defvars SYSVAR_AREA

; System:
        ubScreenBase            ds.b    1
                                ds.b    10      ; $020C
        KbdData                 ds.b    9       ; $0216 data on both negative and positive side
                                ds.b    10      ; $021F
        SerTXHandle                             ; $0229 on negative side
                                ds.b    10
        SerRXHandle                             ; $0233 on negative side
        _u_0                    ds.b    4
        ubFsTemp                ds.b    1       ; $0237
        uwSmallTimer            ds.w    1       ; $0238
        uwSlotAvailFsBlocks     ds.w    5       ; $023a ds.b 5*2
        pFsMemPool              ds.w    1       ; $0244
        uwFsAvailBlock          ds.w    1       ; $0246
        _u_1                    ds.w    1
        word_024A               ds.w    1       ; $024a used in nqsp.asm
        _u_2                    ds.w    1
        pMTHScreenSave          ds.w    1       ; $024e
        pMTHHelpHandle          ds.w    1       ; $0250
        word_0252               ds.w    1       ; $0252 used in nqsp.asm
        _u_3                    ds.w    1
        uwPanelFilePtr          ds.w    1       ; $0256
        ubSysFlags1             ds.b    1       ; $0258
        cExtendedChar           ds.b    1       ; $0259
        OZcmdBuf                ds.b    6       ; $025a
        pNMIStackPtr            ds.w    1       ; $0260
        ubWaitCount1            ds.b    1       ; $0262
        ubWaitCount2            ds.b    1       ; $0263
        ubTimeoutCnt            ds.b    1       ; $0264
        ubCLIActiveCnt          ds.b    1       ; $0265
        ubNextAlmSeconds        ds.b    1       ; $0266
        uwNextAlmMinutes        ds.w    1       ; $0267
        ubNextAlmMinutesB       ds.b    1       ; $0269
        ubSoundActive           ds.b    1       ; $026a
        ubSoundCount            ds.b    1       ; $026b
        _u_4                    ds.w    1       
        ubAlmDisableCnt         ds.b    1       ; $026e
        ubAlmDisplayCnt         ds.b    1       ; $026f
        ubNumActiveAlm          ds.b    1       ; $0270
        ubAlmActionCnt          ds.b    1       ; $0271
        pFirstAlarm             ds.w    1       ; $0272
        pNextAlmHandle          ds.w    1       ; $0274
        pPrefs1                 ds.w    1       ; $0276
        pPrefs2                 ds.w    1       ; $0278
        ulSlot1ID               ds.l    1       ; $027b
        ulSlot2ID               ds.l    1       ; $027f
        ulSlot3ID               ds.l    1       ; $0283
        ubHlpActiveCmd          ds.b    1       ; $0287
        ubHlpActiveTpc          ds.b    1       ; $0288
        ubHlpActiveHelp         ds.b    1       ; $0289
        ubHlpActiveApp          ds.b    1       ; $028a
        _u_5                    ds.b    1
        eHlpAppDOR              ds.p    1       ; $028c
        eHlpTopics              ds.p    1       ; $028f
        eHlpCommands            ds.p    1       ; $0292
        eHlpHelp                ds.p    1       ; $0295
        eHlpTokens              ds.p    1
        ActiveAppHandle         ds.b    16      ; actual handle structure
        uwOSTinTimeout          ds.w    1
        pOSEntHandle            ds.w    1

; Active application (51):
        uwAppStaticHnd          ds.w    1       ; pAppEnvHandle - uwAppStaticHnd - 1 is cleared when new app is created
        ubAppDynID              ds.b    1
        ubAppResCycle           ds.b    1
        pAppEntrypoint          ds.w    1
        ubAppDORFlags           ds.b    1
        ubAppDORFlags2          ds.b    1
        uwAppEnvOverhead        ds.w    1
        pAppStackPtr            ds.w    1
        pAppUnSafeArea          ds.w    1
        pAppBadMemTable         ds.w    1
        pAppBadMemHandle        ds.w    1
        ubAppContRAM            ds.b    1
        ubAppBindings           ds.b    4
        ubAppKbdBits            ds.b    1
        pMailbox                ds.w    1
        ubMailboxSize           ds.b    2       ; 1 more, try to remove...
        pAppErrorHandler        ds.w    1
        ubAppLastError          ds.b    1
        ubAppCallLevel          ds.b    1
        ubOldCallLevel          ds.b    1
        pAppHelpHandle          ds.w    1
        ubAppHelpBank           ds.b    1
        eAppDOR_2               ds.p    1
        eAppTopics_2            ds.p    1
        eAppCommands_2          ds.p    1
        eAppHelp_2              ds.p    1
        eAppTokens_2            ds.p    1

; System (16):
        pAppEnvHandle           ds.w    1
        uwFreeRAMPages          ds.w    1
        pFirstHandle            ds.w    1
        ubIntTaskToDo           ds.b    1
        ubIntStatus             ds.b    1
        ubSlotRAMoffset         ds.b    4
        ubSlotRamSize           ds.b    4

; Random (5):
        ubRandomPtr             ds.b    1
        uwRandom1               ds.w    1
        uwRandom2               ds.w    1

; NMI/wait (53):
        uwTimecounter           ds.w    1
        ubTimecounterSoft       ds.b    1
        NMIStackBottom          ds.b    48
        NMIStackTop             ds.w    1

; Keymaps (10):
        ubKmBank                ds.b    1       ; memory bank where tables are, bound in S2
        ubKmPage                ds.b    1       ; high byte of address
        ubKmCaps                ds.b    1       ; low byte of CAPS translation table address
        ubKmDiamond             ds.b    1       ; low byte of <> translation table address
        ubKmSquare              ds.b    1       ; low byte of [] translation table address
        ubKmDeadkey             ds.b    1       ; low byte of deadkey table address
        ubKmDeadchar            ds.b    1       ; char displayed in OZ window
        ubKmDeadsub             ds.b    1       ; offset to list for current deadkey
        aKmCountry              ds.w    1       ; country id for OZ window

enddef        



defvars PRESERVED_AREA

; Preserved clocks (22):
        sysvar_area_presv
        ubTimeBufferSelect      ds.b    1       ; select time buffer A or B (was $2100A0)
        ubTIM0_A                ds.b    1       ; buffer A : TIM0-4
        ubTIM1_A                ds.b    1
        ubTIM2_A                ds.b    1
        ubTIM3_A                ds.b    1
        ubTIM4_A                ds.b    1
        ubTIM0_B                ds.b    1       ; buffer B : TIM0-4
        ubTIM1_B                ds.b    1
        ubTIM2_B                ds.b    1
        ubTIM3_B                ds.b    1
        ubTIM4_B                ds.b    1
        uwSysDateLow            ds.w    1       ; 11 bytes buffer for system time
        uwSysDateMid            ds.w    1
        uwSysDateHigh           ds.w    1
        SysTimeBuffer           ds.b    5

; Preserved panel (7):
        ubResetType             ds.b    1       ; $00 hard / $FF soft
        ubTimeout               ds.b    1       ; panel system parameters
        ubRepeat                ds.b    1       ; "
        cKeyclick               ds.b    1       ; "
        cSound                  ds.b    1       ; "
        ubBadSize               ds.b    1       ; "
        cCountry                ds.b    1       ; country code
        sysvar_area_presv_end

enddef

defvars HARDWARE_AREA

; Screen softcopies:
                                ds.b    32
                                
; Keyboard buffer
        KbdBuffer               ds.b    48

; Other blink port softcopies:
                                ds.b    64

; User port softcopies:
                                ds.b    16      ; free

; Handles
        Handles                 ds.b    16*96   ; $0500-$0AFF HNDLEN * NUMHANDLE

; Serial interface buffers
        SerTXBuffer             ds.b    128     ; $0B00-$0B7F
        SerRXBuffer             ds.b    128     ; $0B80-$0BFF

; EPROM:
        ubEpr_NameLen           ds.b    1
        pEpr_PrgTable           ds.w    1
        pEpr_Parsedname         ds.w    1
        pEpr_FileHandle         ds.w    1

; Printer:
        StackBufPtr             ds.w    1
        CtrlBuf                 ds.w    1
        CtrlLen                 ds.b    1
        prtInChar               ds.b    1
        Translations            ds.b    37
        PlaceHolderChar         ds.b    1
        PendingSpaces           ds.b    1
        Rows                    ds.b    1
        PageLen                 ds.b    1
        Flags                   ds.b    1
        AttrUnderline           ds.b    1
        AttrBold                ds.b    1
        AttrExtended            ds.b    1
        AttrItalics             ds.b    1
        AttrSubscript           ds.b    1
        AttrSuperscript         ds.b    1
        AttrAltfont             ds.b    1
        AttrUserdef             ds.b    1

; Index:
        ubIdxPubFlags           ds.b    1
        ubIdxFlags2             ds.b    1
        ubIdxTopProcess         ds.b    1
        ubIdxNProcDisplayed     ds.b    1
        ubIdxTopApplication     ds.b    1
        ubIdxNApplDisplayed     ds.b    1
        ubIdxSelectorPos        ds.b    1
        ubIdxActiveWindow       ds.b    1
        ubIdxErrorCode          ds.b    1
        ubIdxProcRmCount        ds.b    1
        ubIdxDynamicID          ds.b    1
        ubIdxOldProcRmCount     ds.b    1
        pIdxMemHandle           ds.b    2
        pIdxCurrentProcHandle   ds.b    2
        pIdxMyProcHandle        ds.b    2       ; static handle of Index
        pIdxRunProcIX           ds.b    2
        pIdxAutoRunAppl         ds.b    2
        eIdxCliList             ds.b    3
        eIdxProcList            ds.b    3
        eIdxIndexProc           ds.b    3
        eIdxRunProc             ds.b    3
        IdxKeyTable             ds.b    50
        IdxZKeyTable            ds.b    50
        IdxZZKeyTable           ds.b    50

; GN calls:
        uwGnDateLow             ds.w    1
        uwGnDateMid             ds.w    1
        uwGnDateHigh            ds.w    1
        GnHwTimeBuf             ds.b    5
        GnFnameBuf              ds.b    206
        pAlarmList              ds.p    1       ; badly named (eAlarmList)
        uwNextAlarmID           ds.w    1

; Serial interface flow:
        ubSerParity             ds.b    1
        ubSerFlowControl        ds.b    1
        cSerXonXoffChar         ds.b    1

enddef

; ------------------------
; APPLICATION PROCESS AREA
; ------------------------

defvars PROCESS_AREA

; Mailbox:
        MailBoxName             ds.b    17
        ubMailboxLength         ds.b    1
        MailboxData             ds.b    64
        ubMailBoxID             ds.b    1

; Process:
        ubBadInfoBlock          ds.b    1       ; info block length (always $03, the three follwing bytes)
        ubBadInfoStartPage      ds.b    1       ; bad application start page (always $20)
        ubBadInfoEndPage        ds.b    1       ; bad application end page set by AllocBadRAM1
        ubBadInfoReserved       ds.b    1       ; unused (always 00 set in process3.asm/osent_16)
        pStkEntUsedStkBottom    ds.w    1
        uwStkEntUsedStkSize     ds.w    1
        pStkTempStkTop          ds.w    1
        stkBottom                               ; $185d
;                                               ; 5 bytes here ?

enddef

defc    unk_1864                =$1864          ; ???

lston
